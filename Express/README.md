# Express

_Здавалося б, навіщо нам потрібен додатковий фреймворк, якщо ми можемо скористатися готовим модулем http, який є у Node.js API. Однак Express сам використовує модуль http, але водночас надає ряд готових абстракцій, які спрощують створення сервера та серверної логіки, зокрема обробка відправлених форм, робота з куками, CORS тощо._

* Вихідний код фреймворку: https://github.com/expressjs/express
* Установка у проєкті: `npm install express`

- - -

Для використання Express на початку треба створити об'єкт, який представлятиме додаток:
```javascript
  const app = express();
```

Для обробки запитів Express визначено ряд вбудованих функцій, і однією з таких є `app.get()`. Вона обробляє GET-запити протоколу HTTP та дозволяє пов'язати маршрути з певними обробниками. Для цього першим параметром передається маршрут, а другим - обробник, який буде викликатись, якщо запит до сервера відповідає даному маршруту.

```javascript
  app.get("/", function(request, response){     
      // відправляємо відповідь
      response.send("<h2>Привіт від Express!</h2>");
  });
```

> _І що важливо, Express спирається на систему маршрутів, тому всі інші запити, які не відповідають кореневому маршруту "/", не будуть оброблятися._

- - -

## Конвеєр обробки запиту та middleware

_Коли фреймворк Express отримує запит, цей запит передається до конвеєра обробки. Конвеєр складається з набору компонентів або middleware, які отримують дані запиту та вирішують, як його обробляти._

При необхідності ми можемо вбудувати конвеєр обробки запиту на будь-якому етапі будь-яку функцію middleware. Для цього використовується метод `app.use()`.

```javascript
  app.use(function(request, response, next){    
    console.log("виконується Middleware 1");
    next();
  });
```

Middleware допомагають виконувати деякі завдання, які мають бути зроблені до надсилання відповіді.\
Стандартне завдання – логування запитів.

```javascript
  // цей middleware виконується кожного разу при http-запиті
  app.use(function(request, response, next){     
    let now = new Date();
    let hour = now.getHours();
    let minutes = now.getMinutes();
    let seconds = now.getSeconds();
    let data = `${hour}:${minutes}:${seconds} ${request.method} ${request.url} ${request.get("user-agent")}`;
    console.log(data);
    fs.appendFile("server.log", data + "\n", function(){});
    next();
  });
```

## Надсилання відповіді

_Для надсилання відповіді в express у об'єкта response можна використовувати низку функцій. Найпоширеніший спосіб надсилання відповіді представляє функція `send()`. Як параметр ця функція може приймати об'єкт Buffer, рядок, у тому числі з html-кодом, об'єкт javascript або масив._

```javascript
  app.get("/", function(request, response){
     console.log("відбувся перехід на /");
      // відправляємо відповідь
	  response.sendFile(__dirname + "/views/index.html");
  });
```

Функція ``sendStatus()`` надсилає користувачеві певний статусний код з деяким стандартним повідомленням.

```javascript
  app.use("/home/foo/",function (request, response) {
      response.status(404).send(`Такий ресурс не знайдено`);
  });
```

### Статичні файли

У випадку ``app.use(express.static(__dirname + "/public"));`` ми безпосередньо звертаємося до статичних файлів, а функція ``sendFile`` фактично бере вміст із файлу та відсилає його користувачеві.

```javascript
    app.use("/static", express.static(__dirname + "/views"));

  // http://localhost:5000/static/about.html
```

- - -

## Маршрутизація

_Під час обробки запитів фреймворк Express спирається на систему маршрутизації. У додатку визначаються маршрути та обробники цих маршрутів. Якщо запит відповідає певному маршруту, викликається для обробки запиту відповідний обробник._

Як перший параметр ці функції можуть приймати шаблон адреси, запит за яким оброблятиметься. Другий параметр функцій представляє функцію, яка буде обробляти запит за адресою, що збіглася з шаблоном.

> Шаблони адрес, що використовуються, можуть містити регулярні вирази або спеціальні символи підстановок.
* `?` вказує, що попередній символ може зустрічатися 1 раз або відсутній
  + app.get("/bo?k", function (request, response)
    - маршрут буде відповідати рядку запиту "/bk" або "/bok"
* `+` вказує, що попередній символ може зустрічатися 1 і більше разів
  + app.get("/bo+k", function (request, response)
    - маршрут відповідатиме запитам "/bok", "/book", "/booоk"
* `*` вказує, що на місці даного символу може бути будь-яка кількість символів
  + app.get("/bo*k", function (request, response)
    - маршрут відповідатиме запитам "/bork", "/bonk", "/bor.dak", "/bor/ok" і так далі
* `()` дозволяють оформити групу символів, які можуть зустрічатися у запиті
  + app.get("/book(.html)?", function (request, response)
    - вказує, що ".html" може зустрічатися або бути відсутнім в рядку запиту.





